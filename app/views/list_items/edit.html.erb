<!-- app/views/list_items/edit.html.erb -->
<%= turbo_frame_tag "modal" do %>
  <div class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 flex items-center justify-center p-4"
       data-controller="modal"
       data-modal-target="modal">
    <div class="relative bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-auto border border-gray-200 max-h-[90vh] overflow-y-auto"
         data-modal-target="backdrop"
         data-action="click->modal#clickOutside">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-gray-200 sticky top-0 bg-white rounded-t-xl">
        <div class="flex-1">
          <h2 class="text-lg font-semibold text-gray-900">Edit Item</h2>
          <p class="text-sm text-gray-500 mt-1"><%= @list.title %></p>
        </div>
        <button data-action="click->modal#close"
          class="ml-4 text-gray-400 hover:text-gray-600 transition-colors duration-200 shrink-0">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-6 overflow-y-auto">
        <%= form_with model: [@list, @list_item], local: true, class: "space-y-6", data: { controller: "date-calculator" } do |f| %>
          <!-- Error Messages -->
          <% if @list_item.errors.any? %>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
              <div class="flex items-start space-x-3">
                <svg class="w-5 h-5 text-red-600 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                  <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
                  <ul class="mt-2 text-sm text-red-700 list-disc list-inside space-y-1">
                    <% @list_item.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                </div>
              </div>
            </div>
          <% end %>

          <!-- Content Section -->
          <div class="space-y-4">
            <h3 class="text-sm font-semibold text-gray-900">Content</h3>
            <!-- Title Field -->
            <div>
              <%= f.label :title, class: "block text-sm font-medium text-gray-700 mb-1" %>
              <%= f.text_field :title,
                              placeholder: "Item title...",
                              class: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
            </div>
            <!-- Description Field -->
            <div data-controller="wysiwyg-markdown">
              <%= f.label :description, class: "block text-sm font-medium text-gray-700 mb-1" do %>
                Description <span class="text-xs font-normal text-gray-500">(optional, markdown)</span>
              <% end %>
              <div data-wysiwyg-markdown-target="editor" class="border border-gray-300 rounded-lg"></div>
              <%= f.hidden_field :description, data: { "wysiwyg-markdown-target": "input" } %>
            </div>
          </div>

          <!-- Classification Section -->
          <div class="space-y-4">
            <h3 class="text-sm font-semibold text-gray-900">Classification</h3>
            <div class="grid grid-cols-3 gap-4">
              <!-- Type Select -->
              <div>
                <%= f.label :item_type, "Type", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.select :item_type,
                            options_for_select([
                              ['Task', 'task'],
                              ['Milestone', 'milestone'],
                              ['Feature', 'feature'],
                              ['Bug', 'bug'],
                              ['Idea', 'idea'],
                              ['Note', 'note'],
                              ['Reference', 'reference'],
                              ['Decision', 'decision'],
                              ['Travel', 'travel'],
                              ['Shopping', 'shopping'],
                              ['Learning', 'learning'],
                              ['Health', 'health'],
                              ['Finance', 'finance'],
                              ['Home', 'home'],
                              ['Social', 'social'],
                              ['Habit', 'habit']
                            ], @list_item.item_type),
                            {},
                            class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
              </div>
              <!-- Priority Select -->
              <div>
                <%= f.label :priority, "Priority", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.select :priority,
                            options_for_select([
                              ['Low', 'low'],
                              ['Medium', 'medium'],
                              ['High', 'high'],
                              ['Urgent', 'urgent']
                            ], @list_item.priority),
                            {},
                            class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
              </div>
              <!-- Status Select -->
              <div>
                <%= f.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%= f.select :status,
                            options_for_select([
                              ['Pending', 'pending'],
                              ['In Progress', 'in_progress'],
                              ['Completed', 'completed']
                            ], @list_item.status),
                            {},
                            class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
              </div>
            </div>
          </div>

          <!-- Timeline Section -->
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-semibold text-gray-900">Timeline</h3>
              <button type="button" data-action="date-calculator#clearAllDates" class="text-xs text-red-600 hover:text-red-800 font-medium transition-colors">
                Clear all
              </button>
            </div>
            <div class="grid grid-cols-3 gap-4">
              <!-- Start Date -->
              <div>
                <div class="flex items-center justify-between mb-1">
                  <%= f.label :start_date, class: "block text-sm font-medium text-gray-700" do %>
                    Start Date
                  <% end %>
                  <button type="button" data-action="date-calculator#setTodayStartDate" class="text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors">
                    Today
                  </button>
                </div>
                <% is_recent_default = @list_item.start_date && @list_item.updated_at && (@list_item.updated_at - @list_item.start_date).abs < 60.seconds
                   start_date_value = (is_recent_default && @list_item.updated_at == @list_item.created_at) ? nil : @list_item.start_date&.strftime("%Y-%m-%dT%H:%M") %>
                <%= f.datetime_local_field :start_date,
                                           value: start_date_value,
                                           placeholder: "YYYY-MM-DD HH:MM",
                                           data: { "date-calculator-target": "startDate", action: "date-calculator#onStartDateChange" },
                                           class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder:text-gray-400" %>
              </div>
              <!-- Duration Days -->
              <div>
                <div class="flex items-center justify-between mb-1">
                  <%= f.label :duration_days, class: "block text-sm font-medium text-gray-700" do %>
                    Duration (Days)
                  <% end %>
                  <button type="button" data-action="date-calculator#clearDuration" class="text-xs text-red-600 hover:text-red-800 font-medium transition-colors">
                    Clear
                  </button>
                </div>
                <% duration_value = @list_item.duration_days.to_i > 0 ? @list_item.duration_days : nil %>
                <%= f.number_field :duration_days,
                                  value: duration_value,
                                  min: 0,
                                  placeholder: "value in days",
                                  data: { "date-calculator-target": "duration", action: "date-calculator#onDurationChange" },
                                  class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder:text-gray-400" %>
              </div>
              <!-- Due Date -->
              <div>
                <%= f.label :due_date, class: "block text-sm font-medium text-gray-700 mb-1" do %>
                  Due Date
                <% end %>
                <% due_date_value = @list_item.due_date&.strftime("%Y-%m-%dT%H:%M") %>
                <%= f.datetime_local_field :due_date,
                                           value: due_date_value,
                                           placeholder: "YYYY-MM-DD HH:MM",
                                           data: { "date-calculator-target": "dueDate", action: "date-calculator#onDueDateChange" },
                                           class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder:text-gray-400" %>
              </div>
            </div>
          </div>

          <!-- Assignment & Links Section -->
          <div class="space-y-4">
            <h3 class="text-sm font-semibold text-gray-900">Assignment & Links</h3>
            <div class="grid grid-cols-2 gap-4">
              <!-- Assigned User -->
              <div>
                <%= f.label :assigned_user_id, "Assign To", class: "block text-sm font-medium text-gray-700 mb-1" %>
                <%
                  assignable_users = [current_user, @list.owner]
                  assignable_users.concat(@list.collaborator_users)
                  assignable_users = assignable_users.uniq(&:id)
                %>
                <%= f.select :assigned_user_id,
                             options_from_collection_for_select(assignable_users, :id, ->(user) { format_assignee_name(user) }, @list_item.assigned_user_id),
                             { prompt: "Unassigned" },
                             class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
              </div>
              <!-- URL Field -->
              <div>
                <%= f.label :url, class: "block text-sm font-medium text-gray-700 mb-1" do %>
                  Link <span class="text-xs font-normal text-gray-500">(optional)</span>
                <% end %>
                <%= f.url_field :url,
                               placeholder: "https://example.com",
                               class: "w-full h-10 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="flex gap-2 pt-4 border-t border-gray-200">
            <%= f.submit "Save Changes",
                        class: "px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors duration-200" %>
            <button type="button" data-action="click->modal#close"
              class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200 font-medium">
              Cancel
            </button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>
