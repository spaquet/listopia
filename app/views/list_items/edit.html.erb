<!-- app/views/list_items/edit.html.erb -->
<div class="space-y-6">
  <!-- Header with Back Buttons -->
  <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="flex items-center gap-3">
      <%= link_to @list, class: "inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200 w-fit" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        <span class="text-gray-600">Back to</span>
        <span class="ml-1 font-semibold text-gray-900 truncate max-w-xs"><%= @list.title %></span>
      <% end %>
      <span class="text-gray-400">/</span>
      <%= link_to list_list_item_path(@list, @list_item), class: "inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors duration-200 w-fit" do %>
        <span class="text-gray-600">Back to</span>
        <span class="ml-1 font-semibold text-gray-900 truncate max-w-xs"><%= @list_item.title %></span>
      <% end %>
    </div>
    <h1 class="text-3xl font-bold text-gray-900">Edit Item</h1>
  </div>
  <!-- Edit Form Card -->
  <div class="bg-white rounded-lg shadow-md border border-gray-200 p-8">
    <%= form_with model: [@list, @list_item], local: true, class: "space-y-8", data: { controller: "date-calculator" } do |f| %>
      <!-- Error Messages -->
      <% if @list_item.errors.any? %>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex items-start space-x-3">
            <svg class="w-5 h-5 text-red-600 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
              <h3 class="text-sm font-medium text-red-800">Please fix the following errors:</h3>
              <ul class="mt-2 text-sm text-red-700 list-disc list-inside space-y-1">
                <% @list_item.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      <% end %>
      <!-- Section: Content -->
      <div class="space-y-4">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
          </svg>
          Content
        </h2>
        <!-- Title Field -->
        <div>
          <%= f.label :title, class: "block text-sm font-semibold text-gray-900 mb-2" %>
          <%= f.text_field :title,
                          placeholder: "Item title...",
                          class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
        </div>
        <!-- Description Field with ProseMirror WYSIWYG Markdown Editor -->
        <div data-controller="wysiwyg-markdown">
          <%= f.label :description, class: "block text-sm font-semibold text-gray-900 mb-2" do %>
            Description <span class="text-xs font-normal text-gray-500">(optional, markdown supported)</span>
          <% end %>
          <div data-wysiwyg-markdown-target="editor"></div>
          <%= f.hidden_field :description, data: { "wysiwyg-markdown-target": "input" } %>
        </div>
      </div>
      <!-- Section: Classification -->
      <div class="space-y-4">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
          </svg>
          Classification
        </h2>
        <!-- Type, Priority, and Status Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Type Select -->
          <div>
            <%= f.label :item_type, "Type", class: "block text-sm font-semibold text-gray-900 mb-2" %>
            <%= f.select :item_type,
                        options_for_select([
                          ['Task', 'task'],
                          ['Milestone', 'milestone'],
                          ['Feature', 'feature'],
                          ['Bug', 'bug'],
                          ['Idea', 'idea'],
                          ['Note', 'note'],
                          ['Reference', 'reference'],
                          ['Decision', 'decision'],
                          ['Travel', 'travel'],
                          ['Shopping', 'shopping'],
                          ['Learning', 'learning'],
                          ['Health', 'health'],
                          ['Finance', 'finance'],
                          ['Home', 'home'],
                          ['Social', 'social'],
                          ['Habit', 'habit']
                        ], @list_item.item_type),
                        {},
                        class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
          </div>
          <!-- Priority Select -->
          <div>
            <%= f.label :priority, "Priority", class: "block text-sm font-semibold text-gray-900 mb-2" %>
            <%= f.select :priority,
                        options_for_select([
                          ['Low', 'low'],
                          ['Medium', 'medium'],
                          ['High', 'high'],
                          ['Urgent', 'urgent']
                        ], @list_item.priority),
                        {},
                        class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
          </div>
          <!-- Status Select -->
          <div>
            <%= f.label :status, "Status", class: "block text-sm font-semibold text-gray-900 mb-2" %>
            <%= f.select :status,
                        options_for_select([
                          ['Pending', 'pending'],
                          ['In Progress', 'in_progress'],
                          ['Completed', 'completed']
                        ], @list_item.status),
                        {},
                        class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
          </div>
        </div>
      </div>
      <!-- Section: Timeline -->
      <div class="space-y-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            Timeline
          </h2>
          <button type="button" data-action="date-calculator#clearAllDates" class="text-xs text-red-600 hover:text-red-800 font-medium transition-colors">
            Clear all
          </button>
        </div>
        <!-- Start Date, Duration, and Due Date Row -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Start Date -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <%= f.label :start_date, class: "block text-sm font-semibold text-gray-900" do %>
                Start Date <span class="text-xs font-normal text-gray-500">(optional)</span>
              <% end %>
              <button type="button" data-action="date-calculator#setTodayStartDate" class="text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors">
                Today
              </button>
            </div>
            <% # Only show start_date value if it's more than 1 minute old (i.e., user explicitly set it)
               # or if the item was saved more than a minute ago, it's likely user-set
               is_recent_default = @list_item.start_date && @list_item.updated_at && (@list_item.updated_at - @list_item.start_date).abs < 60.seconds
               start_date_value = (is_recent_default && @list_item.updated_at == @list_item.created_at) ? nil : @list_item.start_date&.strftime("%Y-%m-%dT%H:%M") %>
            <%= f.datetime_local_field :start_date,
                                       value: start_date_value,
                                       placeholder: "YYYY-MM-DD HH:MM",
                                       data: { "date-calculator-target": "startDate", action: "date-calculator#onStartDateChange" },
                                       class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder:text-gray-400" %>
          </div>
          <!-- Duration Days -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <%= f.label :duration_days, class: "block text-sm font-semibold text-gray-900" do %>
                Duration (Days) <span class="text-xs font-normal text-gray-500">(optional)</span>
              <% end %>
              <button type="button" data-action="date-calculator#clearDuration" class="text-xs text-red-600 hover:text-red-800 font-medium transition-colors">
                Clear
              </button>
            </div>
            <% duration_value = @list_item.duration_days.to_i > 0 ? @list_item.duration_days : nil %>
            <%= f.number_field :duration_days,
                              value: duration_value,
                              min: 0,
                              placeholder: "value in days",
                              data: { "date-calculator-target": "duration", action: "date-calculator#onDurationChange" },
                              class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder:text-gray-400" %>
          </div>
          <!-- Due Date -->
          <div>
            <%= f.label :due_date, class: "block text-sm font-semibold text-gray-900 mb-2" do %>
              Due Date <span class="text-xs font-normal text-gray-500">(optional)</span>
            <% end %>
            <% due_date_value = @list_item.due_date&.strftime("%Y-%m-%dT%H:%M") %>
            <%= f.datetime_local_field :due_date,
                                       value: due_date_value,
                                       placeholder: "YYYY-MM-DD HH:MM",
                                       data: { "date-calculator-target": "dueDate", action: "date-calculator#onDueDateChange" },
                                       class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all placeholder:text-gray-400" %>
          </div>
        </div>
      </div>
      <!-- Section: Assignment & Links -->
      <div class="space-y-4">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
          <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.658 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
          </svg>
          Assignment & Links
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Assigned User -->
          <div>
            <div class="flex items-center justify-between mb-2">
              <%= f.label :assigned_user_id, "Assign To", class: "block text-sm font-semibold text-gray-900" do %>
                Assign To <span class="text-xs font-normal text-gray-500">(optional)</span>
              <% end %>
              <%= link_to "Share Collaborators",
                          share_list_list_item_path(@list, @list_item),
                          class: "text-xs text-blue-600 hover:text-blue-800 font-medium transition-colors",
                          data: { turbo_frame: "modal", turbo_prefetch: false } %>
            </div>
            <%
              assignable_users = [current_user, @list.owner]
              assignable_users.concat(@list.collaborator_users)
              assignable_users = assignable_users.uniq(&:id)
            %>
            <%= f.select :assigned_user_id,
                         options_from_collection_for_select(assignable_users, :id, ->(user) { format_assignee_name(user) }, @list_item.assigned_user_id),
                         { prompt: "Unassigned" },
                         class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
          </div>
          <!-- URL Field -->
          <div>
            <%= f.label :url, class: "block text-sm font-semibold text-gray-900 mb-2" do %>
              Link <span class="text-xs font-normal text-gray-500">(optional)</span>
            <% end %>
            <%= f.url_field :url,
                           placeholder: "https://example.com",
                           class: "w-full h-11 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all" %>
          </div>
        </div>
      </div>
      <!-- Form Actions -->
      <div class="border-t border-gray-200 pt-8">
        <div class="flex flex-col-reverse md:flex-row md:items-center md:justify-between gap-4">
          <!-- Left Actions -->
          <div class="flex items-center gap-2">
            <%= link_to list_list_item_path(@list, @list_item), class: "px-4 py-2 text-gray-700 hover:text-gray-900 font-medium transition-colors rounded-lg hover:bg-gray-100" do %>
              Cancel
            <% end %>
            <%= button_to list_list_item_path(@list, @list_item),
                         method: :delete,
                         data: {
                           turbo_confirm: "Are you sure you want to delete this item? This action cannot be undone.",
                           turbo_stream: true
                         },
                         form: { class: "inline-block" },
                         class: "px-4 py-2 text-red-600 hover:text-red-700 hover:bg-red-50 font-medium transition-colors rounded-lg bg-transparent border-0 cursor-pointer" do %>
              Delete
            <% end %>
          </div>
          <!-- Right Actions -->
          <div>
            <%= f.submit "Save Changes",
                        class: "w-full md:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 active:bg-blue-800 transition-colors duration-200 shadow-md hover:shadow-lg" %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  <!-- Modal Frame for Share Modal -->
  <%= turbo_frame_tag "modal" do %>
  <% end %>
</div>