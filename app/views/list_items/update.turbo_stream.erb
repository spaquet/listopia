<!-- app/views/list_items/update.turbo_stream.erb -->
<!-- Remove card from its old location (always remove first) -->
<%= turbo_stream.remove "item_#{@list_item.id}" %>

<% if @list_item.board_column_id.present? %>
  <!-- List-specific kanban view: board column was updated, append to board column -->
  <% new_column_id = @list_item.board_column_id %>

  <%= turbo_stream.append "column_#{new_column_id}" do %>
    <%= render "list_items/kanban_card", item: @list_item, list: @list %>
  <% end %>

  <!-- Update header for current viewer -->
  <%= turbo_stream.replace "list-header-#{@list.id}" do %>
    <%= render "lists/header", list: @list %>
  <% end %>

  <!-- Broadcast header update to other viewers -->
  <% Turbo::StreamsChannel.broadcast_replace_to(
    "list_#{@list.id}_header",
    target: "list-header-#{@list.id}",
    partial: "lists/header",
    locals: { list: @list, current_user: current_user }
  ) %>
<% else %>
  <!-- Check if column exists for items_kanban view (status-based) by trying to append to it -->
  <% status_column_name = case @list_item.status
  when "completed"
    "Done"
  when "in_progress"
    "In Progress"
  else
    "To Do"
  end %>

  <!-- Append to status-based column (for items_kanban view) -->
  <%= turbo_stream.append "column_#{status_column_name.parameterize}" do %>
      <div id="item_<%= @list_item.id %>"
           class="group relative bg-white rounded-lg border border-gray-200 hover:border-blue-300 hover:shadow-md transition-all duration-200 p-4 cursor-move"
           data-item-id="<%= @list_item.id %>"
           data-list-id="<%= @list_item.list.id %>"
           data-kanban-target="card">

        <!-- Quick Actions (on hover) -->
        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center space-x-1 pointer-events-none group-hover:pointer-events-auto">
          <!-- Edit -->
          <%= link_to edit_list_list_item_path(@list_item.list, @list_item),
                      data: { turbo_frame: "modal" },
                      class: "p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-all pointer-events-auto",
                      title: "Edit" do %>
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
          <% end %>

          <!-- Delete -->
          <% if can_access_list?(@list_item.list, current_user, :edit) %>
            <%= button_to list_list_item_path(@list_item.list, @list_item),
                          method: :delete,
                          data: { turbo_confirm: "Delete this item?" },
                          class: "p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-all pointer-events-auto",
                          title: "Delete" do %>
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            <% end %>
          <% end %>
        </div>

        <!-- List Badge -->
        <div class="mb-2">
          <%= link_to list_path(@list_item.list), class: "inline-block" do %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              <%= @list_item.list.title %>
            </span>
          <% end %>
        </div>

        <!-- Item Type Icon -->
        <div class="flex items-start justify-between gap-2 mb-2">
          <div class="flex items-center space-x-2">
            <%= item_type_icon(@list_item.item_type) %>
            <span class="text-xs text-gray-600"><%= @list_item.item_type.titleize.gsub('_', ' ') %></span>
          </div>
        </div>

        <!-- Title -->
        <h4 class="font-medium text-sm text-gray-900 mb-3 line-clamp-2 group-hover:text-blue-600 transition-colors">
          <%= link_to @list_item.title, list_list_item_path(@list_item.list, @list_item), data: { turbo_frame: "modal" }, class: "hover:underline" %>
        </h4>

        <!-- Priority & Status badges -->
        <div class="flex items-center space-x-2 mb-3">
          <!-- Priority -->
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium <%=
            case @list_item.priority
            when 'low'
              'bg-gray-100 text-gray-700'
            when 'medium'
              'bg-yellow-100 text-yellow-700'
            when 'high'
              'bg-orange-100 text-orange-700'
            when 'urgent'
              'bg-red-100 text-red-700'
            end %>">
            <%= @list_item.priority.capitalize %>
          </span>

          <!-- Status -->
          <% if @list_item.status_completed? %>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-700">
              âœ“ Done
            </span>
          <% elsif @list_item.status_in_progress? %>
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-700">
              In Progress
            </span>
          <% end %>
        </div>

        <!-- Due Date (if present) -->
        <% if @list_item.due_date.present? %>
          <div class="flex items-center text-xs text-gray-500 mb-3">
            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <span class="<%= 'text-red-500 font-medium' if @list_item.due_date < Time.current && !@list_item.status_completed? %>">
              <%= @list_item.due_date.strftime("%b %d") %>
            </span>
          </div>
        <% end %>

        <!-- Assignee -->
        <% if @list_item.assigned_user.present? %>
          <div class="flex items-center text-xs text-gray-600 pt-2 border-t border-gray-100">
            <div class="w-5 h-5 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 text-white flex items-center justify-center text-xs font-bold mr-1.5 shrink-0">
              <%= @list_item.assigned_user.email[0].upcase %>
            </div>
            <span><%= format_assignee_name(@list_item.assigned_user) %></span>
          </div>
        <% end %>

        <!-- Completion Checkbox (if pending or in progress) -->
        <% if (@list_item.status_pending? || @list_item.status_in_progress?) && current_user && can_access_list?(@list_item.list, current_user) %>
          <div class="mt-3 pt-3 border-t border-gray-100">
            <%= button_to toggle_completion_list_list_item_path(@list_item.list, @list_item),
                          method: :patch,
                          data: { turbo_stream: true },
                          class: "w-full flex items-center justify-center px-2 py-1.5 text-xs text-gray-600 border border-gray-300 rounded hover:bg-gray-50 transition-colors" do %>
              <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              Mark Complete
            <% end %>
          </div>
        <% end %>
      </div>
  <% end %>
<% end %>