<!-- app/views/chat/_unified_chat.html.erb
     Unified chat partial that adapts to different contexts (dashboard, floating, etc.)
     Handles both initial render and Turbo Stream updates
-->

<div id="unified-chat"
     data-controller="unified-chat"
     data-unified-chat-location-value="<%= context.location %>"
     data-unified-chat-chat-id-value="<%= chat.id %>"
     class="<%= context.ui_config[:position] %> <% if context.in_location?(:floating) %>shadow-2xl rounded-lg border border-gray-200<% end %>">

  <!-- Chat Container -->
  <div class="flex flex-col <%= context.ui_config[:chat_height] %> bg-white <% unless context.in_location?(:floating) %>rounded-lg border border-gray-200 shadow-sm<% end %>">

    <!-- Chat Header -->
    <div class="flex items-center justify-between px-3 py-2 border-b border-gray-200 bg-white">
      <div class="flex items-center gap-2">
        <h3 class="font-medium text-sm text-gray-800">
          <% if context.focused_resource.present? %>
            <%= context.focused_resource_name %>
          <% else %>
            Chat
          <% end %>
        </h3>
      </div>

      <% if context.ui_config[:show_new_chat_button] %>
        <%= button_to chats_path,
                      method: :post,
                      form_class: "inline",
                      class: "text-gray-400 hover:text-gray-600 transition-colors",
                      title: "New Chat" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
        <% end %>
      <% end %>
    </div>

    <!-- Messages Container -->
    <div id="chat-messages-<%= chat.id %>"
         class="flex-1 overflow-y-auto p-3 space-y-3"
         data-unified-chat-target="messagesContainer">

      <% if message_history.blank? %>
        <!-- Empty State with Suggestions -->
        <div class="flex flex-col items-center justify-center h-full gap-3 text-center">
          <h2 class="text-sm font-medium text-gray-900">Start a conversation</h2>
          <p class="text-gray-600 text-xs max-w-xs">
            <% if context.focused_resource.present? %>
              Ask anything about <%= context.focused_resource_name %>, or use commands.
            <% else %>
              Try /search, /browse, or start chatting.
            <% end %>
          </p>

          <!-- Available Commands -->
          <div class="mt-3 space-y-1 w-full">
            <div class="space-y-1">
              <% context.suggestions.each do |suggestion| %>
                <button class="w-full text-left px-2 py-1.5 rounded hover:bg-gray-100 transition-colors text-xs"
                        data-action="unified-chat#insertCommand"
                        data-command="<%= suggestion[:command] %>">
                  <span class="font-mono text-blue-600"><%= suggestion[:command] %></span>
                  <span class="text-gray-500 ml-2"><%= suggestion[:description] %></span>
                </button>
              <% end %>
            </div>

            <!-- Context Info -->
            <% if context.focused_resource.present? %>
              <div class="mt-2 pt-2 border-t border-gray-200">
                <p class="text-xs text-gray-500 mb-1">Context: <strong><%= context.focused_resource_name %></strong></p>
              </div>
            <% end %>
          </div>
        </div>
      <% else %>
        <!-- Message History -->
        <% message_history.each do |message| %>
          <%= render "shared/chat_message", message: message, chat_context: context %>
        <% end %>
      <% end %>
    </div>

    <!-- Input Area -->
    <div class="border-t border-gray-200 p-3 bg-white relative">
      <%= form_with url: create_message_chat_path(chat),
                     method: :post,
                     local: true,
                     class: "flex gap-2 relative",
                     data: { unified_chat_target: "messageForm" } do |f| %>
        <!-- Message Input -->
        <%= f.text_field "message[content]",
                         placeholder: "Type / for commands...",
                         class: "flex-1 px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent",
                         data: { unified_chat_target: "messageInput" },
                         autocomplete: "off" %>

        <!-- Submit Button -->
        <%= f.submit "",
                      class: "px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",
                      data: { unified_chat_target: "submitButton" } do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
