<!-- app/views/admin/users/index.html.erb -->
<div class="max-w-7xl mx-auto space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900">User Management</h1>
      <p class="text-gray-600 mt-1">Manage and monitor all users in your organization</p>
    </div>
    <div class="flex items-center space-x-3">
      <%= link_to admin_root_path, class: "text-gray-600 hover:text-gray-900 px-4 py-2 rounded-lg border border-gray-300 hover:border-gray-400 transition-colors" do %>
        <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back
      <% end %>
      <%= link_to new_admin_user_path, class: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center" do %>
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
        </svg>
        Add User
      <% end %>
    </div>
  </div>
  <!-- Filters & Search -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <%= form_with url: admin_users_path, method: :get, local: true, class: "space-y-4" do |f| %>
      <!-- Search Bar -->
      <div class="flex items-center gap-3">
        <div class="flex-1 relative">
          <svg class="absolute left-3 top-3 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <%= f.text_field :query, 
              placeholder: "Search by name or email...", 
              value: params[:query],
              class: "w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
        </div>
        <%= f.submit "Search", class: "bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors" %>
      </div>
      <!-- Filters Row -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Status Filter -->
        <div>
          <%= f.label :status, "Status", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :status, 
              options_for_select(
                [["All Statuses", ""], ["Active", "active"], ["Suspended", "suspended"], ["Inactive", "inactive"]],
                params[:status]
              ),
              { include_blank: false },
              class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
        </div>
        <!-- Role Filter -->
        <div>
          <%= f.label :role, "Role", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :role,
              options_for_select(
                [["All Roles", ""], ["Admin", "admin"], ["User", "user"]],
                params[:role]
              ),
              { include_blank: false },
              class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
        </div>
        <!-- Verification Filter -->
        <div>
          <%= f.label :verified, "Email Verification", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :verified,
              options_for_select(
                [["All", ""], ["Verified", "verified"], ["Unverified", "unverified"]],
                params[:verified]
              ),
              { include_blank: false },
              class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
        </div>
        <!-- Sort Filter -->
        <div>
          <%= f.label :sort_by, "Sort By", class: "block text-sm font-medium text-gray-700 mb-2" %>
          <%= f.select :sort_by,
              options_for_select(
                [["Most Recent", "recent"], ["Oldest", "oldest"], ["Name A-Z", "name_asc"], ["Name Z-A", "name_desc"], ["Email A-Z", "email_asc"], ["Email Z-A", "email_desc"]],
                params[:sort_by] || "recent"
              ),
              { include_blank: false },
              class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" %>
        </div>
      </div>
      <!-- Clear Filters -->
      <div class="flex justify-end">
        <% if [params[:query], params[:status], params[:role], params[:verified]].any?(&:present?) %>
          <%= link_to "Clear Filters", admin_users_path, class: "text-sm text-gray-600 hover:text-gray-900 underline" %>
        <% end %>
      </div>
    <% end %>
  </div>
  <!-- Bulk Actions & Table -->
  <%= form_with url: "/admin/users/bulk_action", method: :post, local: true, id: "bulk_form" do |f| %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <!-- Bulk Actions Bar (visible when users selected) -->
      <div id="bulk_actions_bar" class="hidden bg-blue-50 border-b border-blue-200 px-6 py-3 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-700">
            <span id="selected_count">0</span> user(s) selected
          </span>
        </div>
        <div class="flex items-center space-x-2">
          <%= f.select :bulk_action,
              options_for_select(
                [["Choose action...", ""], ["Suspend", "suspend"], ["Activate", "activate"], ["Make Admin", "make_admin"], ["Remove Admin", "remove_admin"], ["Delete", "delete"]],
                ""
              ),
              { include_blank: false },
              class: "px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent",
              id: "bulk_action_select" %>
          <%= f.submit "Apply", class: "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm", id: "bulk_action_submit" %>
          <button type="button" onclick="clearSelection()" class="text-gray-600 hover:text-gray-900 px-3 py-2 text-sm">Cancel</button>
        </div>
      </div>
      <!-- Table -->
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left">
              <input type="checkbox" id="select_all" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" onchange="toggleSelectAll(this)">
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email Verified</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200" id="users_table_body">
          <% if @users.any? %>
            <% @users.each do |user| %>
              <%= render "user_row", user: user, form: f %>
            <% end %>
          <% else %>
            <tr>
              <td colspan="7" class="px-6 py-12 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
                </svg>
                <p class="mt-2 text-sm text-gray-600">No users found matching your criteria.</p>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <!-- Pagination -->
      <% if false %>
        <!-- Pagination disabled for now -->
      <% end %>
    </div>
  <% end %>
</div>
<style>
  .hidden { display: none; }
</style>
<script>
  const userCheckboxes = document.querySelectorAll('input[name="user_ids[]"]');
  const selectAllCheckbox = document.getElementById('select_all');
  const bulkActionsBar = document.getElementById('bulk_actions_bar');
  const selectedCountSpan = document.getElementById('selected_count');
  const bulkActionSubmit = document.getElementById('bulk_action_submit');
  const bulkActionSelect = document.getElementById('bulk_action_select');

  function updateBulkActionsBar() {
    const selectedCount = Array.from(userCheckboxes).filter(cb => cb.checked).length;
    selectedCountSpan.textContent = selectedCount;

    if (selectedCount > 0) {
      bulkActionsBar.classList.remove('hidden');
    } else {
      bulkActionsBar.classList.add('hidden');
      selectAllCheckbox.checked = false;
    }
  }

  function toggleSelectAll(checkbox) {
    userCheckboxes.forEach(cb => cb.checked = checkbox.checked);
    updateBulkActionsBar();
  }

  function clearSelection() {
    userCheckboxes.forEach(cb => cb.checked = false);
    selectAllCheckbox.checked = false;
    updateBulkActionsBar();
    bulkActionSelect.value = '';
  }

  userCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkActionsBar);
  });

  bulkActionSubmit.addEventListener('click', (e) => {
    if (bulkActionSelect.value === '') {
      e.preventDefault();
      alert('Please select an action');
    }
  });
</script>